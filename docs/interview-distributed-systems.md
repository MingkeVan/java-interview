# 分布式系统

https://aws.amazon.com/cn/builders-library/?cards-body.sort-by=item.additionalFields.customSort&cards-body.sort-order=asc 亚马逊官方博客

## ACID

具有ACID特性的数据库，如关系型数据库（Oracle、MySQL），支持强一致性，通过多版本并发控制协议（MVCC）实现

## CAP定理

### CAP定理简介

CAP定理指的是在分布式系统中，一致性、可用性、分区容错性最多只能同时满足其中的两个。

### 满足CA的例子

如果不要求P（不允许分区），则C（强一致性）和A（可用性）是可以保证的。但其实分区不是你想不想的问题，而是始终会存在，因此CA的系统更多的是允许分区后各子系统依然保持CA。例子如银行转账等场景，一旦分区发生故障，则直接拒绝提供服务。

### 满足AP的例子

为了达到高可用和分区容错性，则一旦分区发生，则节点之间可能会失去联系，为了保证高可用，每个节点只能用本地数据提供服务，这样则可能导致不同节点的数据不一致。例子如eureka。

### 满足CP的例子

为了达到一致性和分区容错性。则在分区发生的时候，势必要在不同节点之间保证强一致性，不同节点间的数据同步就会影响集群整体的可用性。例子有Zookeeper。当进行leader选举时，整个集群是不可用的。

## BASE理论

> BASE理论是Basically Available(基本可用)，Soft State（软状态）和Eventually Consistent（最终一致性）三个短语的缩写，由eBay架构师Dan Pritchett提出来的。
>

### 基本可用（Basically Available）

所谓基本可用就是在出现不可预知的故障时，系统主体功能依然可用。一个比较典型的例子就是在电商促销时，为保护购物系统，部分消费有可能会被导到一个降级页面。

### 软状态（Soft State）

所谓软状态是指允许系统中的数据存在中间状态，并认为这种状态不影响系统的整体可用性。典型的例子如在分布式文件系统中，数据的写入往往是先写入一份，再**异步**生成多个副本（同步生成副本不属于这种情况）。

### 最终一致性（Eventually Consistent）

上面提到了软状态，但是系统**不可以一直处于软状态，必须有一个期限**。在期限过后，应当保证所有副本数据是的一致的，从而达到数据的最终一致性。而在实际工程实践中，最终一致性分为5种：

#### 因果一致性（Causal consistency）

如果节点A在更新完某个数据后通知了节点B，那么节点B之后对该数据的访问和修改都是基于A更新后的值。于此同时，和节点A无因果关系的节点C的数据访问则没有这样的限制。

#### 读己之所写（Read your writes）

节点A更新一个数据后，它自身总是能访问到自身更新过的最新值，而不会看到旧值。其实也算一种因果一致性。

#### 会话一致性（Session consistency）

会话一致性将对系统数据的访问过程框定在了一个会话当中：系统能保证在同一个有效的会话中实现 “读己之所写” 的一致性，也就是说，执行更新操作之后，客户端能够在同一个会话中始终读取到该数据项的最新值。

#### 单调读一致性（Monotonic read consistency）

单调读一致性指的是：如果一个节点从系统中读取出一个数据项的某个值后，那么系统对于该节点后续的任何数据访问都不应该返回更旧的值。

#### 单调写一致性（Monotonic write consistency）

单调写一致性指的是：一个系统要能够保证来自同一个节点的写操作被顺序的执行。

在实际的实践中，这5种系统往往会结合使用，以构建一个具有最终一致性的分布式系统。

## BASE、CAP和ACID区别

**BASE理论**是对**CAP定理**中一致性和可用性权衡的结果，其来源于对大规模互联网分布式系统实践的总结，是基于CAP定律逐步演化而来。

和传统事务的ACID特性是相反的，它完全不同于**ACID**的强一致性模型，而是提出通过牺牲强一致性来获得可用性，并允许数据在一段时间内是不一致的，但最终达到一致状态。

## 分布式一致性协议之paxos、zab、raft

### paxos

> Paxos算法是基于**消息传递**且具有**高度容错特性**的**一致性算法**，是目前公认的解决**分布式一致性**问题**最有效**的算法之一。

### ZAB

zab协议全称zookeeper atomic broadcast protocol，用于解决分布式情况下的一致性协议。ZAB协议是PAXOS协议的改造。

### RAFT

raft协议是paxos协议的改进，实现更简单。

## 一致性hash

todo

## 最佳实践

参考[分布式服务化系统一致性的“最佳实干”](https://www.jianshu.com/p/1156151e20c8)中的若干案例，了解ACID、CAP、BASE等理论的使用场景，了解分布式场景如何通过保证最终一致性。

保证最终一致性：

* 两阶段提交、三阶段提交、TCC协议
* 查询模式
* 补偿模式
  * 异步确保模式
* 定期校对模式
* 可靠消息模式

## 分布式事务

## 分布式缓存

### 缓存模式

> [缓存模式以及缓存的数据一致性](https://stephanietang.github.io/2020/04/13/cache-pattern/)
>
> [缓存更新的套路](https://coolshell.cn/articles/17416.html)

* Cache-Aside
* Read-Through/Write-Through

## 分布式存储

## 分布式计算

## 参考

* [分布式服务化系统一致性的“最佳实干”](https://www.jianshu.com/p/1156151e20c8)
* [分布式系统 - CAP定理](http://www.yidooo.net/2019/02/28/cap-theorem.html)
* [分布式系统 - BASE理论](http://www.yidooo.net/2019/04/21/base-theorem.html)
* [缓存更新的套路](https://coolshell.cn/articles/17416.html)
