# 微服务之服务注册与发现

## 什么是服务注册与发现

**服务注册发现**有三个角色：**服务提供者**、**服务消费者**和**服务中介**。**服务提供者**将自己的**ip和端口**注册到**服务中介**，**服务消费者**根据目标服务名从**服务中介**获取地址进行请求。

## 基于Zookeeper实现服务注册与发现

![img](https://img-blog.csdn.net/20160229174312700)

### 服务注册流程

* 服务提供者B启动时注册自身ip、端口和元数据等到zookeeper
* 服务消费者A启动时获取最新的服务提供者B列表，并保存在缓存中；
* A调用B时根据负载均衡策略选择一个B进行请求。 

### 服务健康

> 使用 ZooKeeper 作为服务注册中心时，服务的健康检测常利用 ZooKeeper 的 Session 活性 Track机制 以及结合 Ephemeral ZNode的机制，简单而言，就是将服务的健康监测绑定在了 ZooKeeper 对于 Session 的健康监测上，或者说绑定在TCP长链接活性探测上了。

### 服务下线

* 当某一个服务B由于异常或人为关闭后，zookeeper集群某一个节点会探测到B节点的变化，更新本节点B的服务列表；
* zookeeper集群多个节点进行数据同步；
* 客户端监听到B服务列表的变化，更新本地缓存。

### 自动重发机制

* B挂掉到A本地缓存列表更新，大概需要3-5s时间（根据网络环境不同）
* 此时当A访问B报错时，需要根据具体报错信息，处理特定异常进行自动重发。

### zookeeper负载均衡的实现思路

zookeeper没有内置负载均衡的实现，需要自己实现。但是可以利用zookeeper的树形数据结构、watcher机制等特性，把zookeeper作为服务和变更通知中心。

？nginx负载均衡的实现思路？

### zookeeper为什么不适合作为注册中心

[阿里巴巴为什么不用 ZooKeeper 做服务发现？](http://jm.taobao.org/2018/06/13/%E5%81%9A%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%EF%BC%9F/)

[微服务注册中心的选型和思考](https://mp.weixin.qq.com/s/y3Ic_XJFEWlIqZ8YcVokxw)

主要有以下几点局限：

* 服务发现速度慢，从服务挂掉到消费者感知需要一定时间；
* 无法保证可用性，因为zookeeper的设计只能保证CAP中的CP。
  * 当重新选举Leader时，集群无法对外提供服务；
  * 一旦某个机房发生网络分区，即该机房在网络上成了孤岛。这就会出现该机房的zk节点由于无法连接leader节点，可读不可写的情况。并且该机房的所有服务不能新部署、重启、扩容和缩容。不然就会出现服务之间无法调用的情况。这其实已经违背了`注册中心不应该破坏服务之间的可连通性`的初衷。
* 性能差。Zookeeper的性能在大规模服务集群场景中存在瓶颈。
  * Zookeeper的写操作都是leader处理的，无法通过水平扩容提高写性能。
  * 存在大量长连接。
  * 每一个写请求都会写事务日志，同时会定期将内存数据镜像dump到磁盘。这会导致性能的降低。
* 服务探活
* 服务容灾
* 客户端设计不优雅
* 易用难精

### Zookeeper服务注册与发现有那些坑？

[采用zookeeper的EPHEMERAL节点机制实现服务集群的陷阱](https://yq.aliyun.com/articles/227260)

## 服务注册与发现进阶

### 如何确定注册的IP和端口？

**确定IP**

* 手动配置IP。适用于物理机房部署，IP比较稳定。
* 遍历网卡，找到第一个不为本地环回地址的IP地址。（dubbo就是采用这种方式）
* 手动指定网卡名，来指定使用哪一块网卡所对应的IP地址进行注册（需要对机房进行统一的网络规划）
* 以上三种如果行不通，则可以直接与服务注册中心建立socket连接，通过`socket.getLocalAddress()`获取本机IP。

**确定端口**

使用应用配置项中的端口

### 为了更好的实现服务治理，注册的信息需要包含哪些？

除了最基本的IP和Port信息外，还会有以下需求：

* 想知道某个HTTP服务是否开启了TLS。
* 想对相同服务下的不同节点设置不同的权重，进行流量调度。
* 将服务分为预发环境和生产环境，方便进行AB Test功能。
* 不同机房的服务注册时加上机房的标签，以实现同机房有限的路由规则。
* 业务应用支持多个框架协议时，想知道使用某种协议的应用有哪些？
* 想知道某个应用依赖哪些服务？

### 如何优雅的实现服务注册和服务下线？

### 如何进行注册服务的健康检查？

**客户端心跳**

* 客户端定时向服务端主动发送“心跳”，表明自己服务状态正常。心跳可以是TCP或HTTP；
* 客户端也可以通过维持与服务端的socket连接实现客户端心跳；

ps：zookeeper服务注册与发现是通过利用临时节点的特性来实现对服务的健康检查。一旦应用出现异常后断开，临时节点就会被删除，进而通知监听该节点的客户端。

缺点：客户端心跳只能保证链路正常，不能保证服务真的正常（如无法探测搭配DB连接异常）

**服务端主动探测**

* 服务端调用服务发布者某个HTTP接口来完成健康检查；
* 有些RPC引用不提供HTTP服务，也可以调用服务发布者的接口来完成健康检查；

缺点：主动调用接口无法做到通用

### 如何方便的查看某个应用发布和订阅了哪些服务，以及所订阅的服务有哪些节点？

- 一个好的产品，用户使用体验和运维体验必须是优雅的，如果查看本机发布和订阅的服务，只能通过查看日志，甚至是 jmap 的方式来获取，显然体验非常糟糕。
- 服务注册中心应该提供了丰富的接口，支持根据应用名、IP、订阅服务名、发布服务名，来进行多层次的组合查询。
- 同时，客户端的内存里，同样也应该保留服务发布与订阅的各种信息，并提供方式供人方便地查询。
- 比如在 Java 中的 Spring Boot 的应用，可以结合 actuator endpoint，通过 HTTP 的方式来提供本机服务查询功能，查询此应用发布的服务，以及订阅的服务及各服务的对应节点。

### 服务容灾

[注册中心的容灾考虑](http://jm.taobao.org/2018/06/13/做服务发现？/#注册中心的容灾考虑)中提到，

>  **在实践中，注册中心不能因为自身的任何原因破坏服务之间本身的可连通性**。

> 服务调用（请求响应流）链路应该是弱依赖注册中心，必须仅在服务发布，机器上下线，服务扩缩容等必要时才依赖注册中心。

> 这需要注册中心仔细的设计自己提供的客户端，客户端中应该有针对注册中心服务完全不可用时做容灾的手段，例如设计客户端**缓存数据机制**（我们称之为 client snapshot）就是行之有效的手段。另外，注册中心的 **health check** 机制也要仔细设计以便在这种情况不会出现诸如推空等情况的出现。

## 服务注册发现的技术对比与选型

![服务注册与发现技术对照表](https://mmbiz.qpic.cn/mmbiz_jpg/wv3K6j4ibl939BZF8TU5SNvYwaQVgibUCpQ02oH9YxSXEAiaNVQKY4iaUXwdWpicW08KIYflPJExtiacLMfI0mQVHWHQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

### watch

> Zookeeper 的 watch 实现比较简单，就是 TCP Ping。
>
> Long Polling（长轮询）是拉模式，客户端每隔一段时间请求拉取一次数据。
>
> 客户端发起 Long Polling，如果服务端没有数据，会等待，直到服务端有数据，或者等待到超时，返回后，客户端会再次发起 Long Polling。

### 服务健康检查

> 心跳方式比较简单，客户端上报自己的存活状态即可。
>
> 但存活不代表健康，例如一个应用的服务层没问题，但数据库连接故障了，那么就无法正常提供服务，这就是存活但不健康。
>
> Eureka 支持服务自定义健康检查逻辑。
>
> Consul 支持的很全面，可以配置服务自定义的健康检查接口地址，还有完善的管理界面，可以查看所有服务和节点的健康检查状态。

## 参考

* https://crossoverjie.top/2018/08/27/distributed/distributed-discovery-zk/
* [服务注册发现技术对比](https://mp.weixin.qq.com/s?__biz=MzA4Nzc4MjI4MQ==&mid=2652403302&idx=1&sn=f1320133d072ac6f0d35a4fd1dfcd2f0)
* [聊聊微服务的服务注册与发现]([http://jm.taobao.org/2018/06/26/%E8%81%8A%E8%81%8A%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0/](http://jm.taobao.org/2018/06/26/聊聊微服务的服务注册与发现/))
* [阿里巴巴为什么不用 ZooKeeper 做服务发现？](http://jm.taobao.org/2018/06/13/%E5%81%9A%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%EF%BC%9F/)
* [Eureka! Why You Shouldn’t Use ZooKeeper for Service Discovery](https://medium.com/knerd/eureka-why-you-shouldnt-use-zookeeper-for-service-discovery-4932c5c7e764)
* [采用zookeeper的EPHEMERAL节点机制实现服务集群的陷阱](https://yq.aliyun.com/articles/227260)

